FROM linux/chef-solo

MAINTAINER Tom Ekl√∂f tom@linux-konsult.com

# Expose the Postgresql port
EXPOSE 5432

RUN apt-get -y update

# Add chef files
ADD ./solo.rb /etc/chef/solo.rb
ADD ./node.json /etc/chef/node.json

# Add Berksfile to install cookbooks
ADD ./Berksfile /Berksfile

# Change the dbpassword string below to something good.
RUN sed -i "s%md5sumhash%$(echo -n 'dbpassword%g''postgres' | openssl md5 | sed -e 's/.* /md5/')%g" /etc/chef/node.json

# Install cookbooks defined in Berkshelf file
RUN /opt/chef/embedded/bin/berks install --path /etc/chef/cookbooks/

# Run cookbooks
RUN chef-solo

# Start the service
ENTRYPOINT ["/bin/su", "postgres", "-c", "/usr/lib/postgresql/9.1/bin/postgres -D /var/lib/postgresql/9.1/main -c config_file=/etc/postgresql/9.1/main/postgresql.conf"]

